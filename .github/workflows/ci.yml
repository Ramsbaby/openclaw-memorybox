name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck
      - name: ShellCheck
        run: shellcheck -S warning bin/memorybox scripts/*.sh

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Test init (fresh workspace)
        run: |
          chmod +x bin/memorybox
          echo "Y" | bin/memorybox init /tmp/test-workspace
          bin/memorybox health /tmp/test-workspace
      - name: Test analyze
        run: bin/memorybox analyze /tmp/test-workspace
      - name: Test report
        run: bin/memorybox report /tmp/test-workspace
      - name: Test doctor
        run: bin/memorybox doctor /tmp/test-workspace
      - name: Test suggest
        run: bin/memorybox suggest /tmp/test-workspace
      - name: Test stale
        run: bin/memorybox stale /tmp/test-workspace
      - name: Test archive
        run: bin/memorybox archive /tmp/test-workspace
      - name: Verify health score
        run: |
          output=$(bin/memorybox health /tmp/test-workspace 2>&1)
          echo "$output"
          echo "$output" | grep -q "100/100" || (echo "Health score not 100!" && exit 1)
